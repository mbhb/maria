#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <time.h>
#include <errno.h>
#include <fcntl.h>

int main() {
    int fd;
    int lock_result;
    
    // Abre un archivo para bloqueo 
    fd = open("ejer15.txt", O_WRONLY | O_CREAT | O_TRUNC, 0666);
    if (fd == -1) {
        perror("open");
        exit(EXIT_FAILURE);
    }
    
    // Intenta bloquear el archivo
    lock_result = lockf(fd, F_TLOCK, 0);
    
    if (lock_result == 0) {
        // Bloqueo exitoso
        // Obtenemos la hora y fecha actual del sistema
        time_t current_time;      // Variable para almacenar la hora actual
        struct tm *time_info;     // Puntero a una estructura de informaci√≥n de tiempo
        time(&current_time);     // Obtenemos la hora actual y la almacenamos en current_time
        time_info = localtime(&current_time); // Convertimos la hora actual en una estructura de tiempo local

        
        printf("Bloqueo exitoso a las %s", asctime(time_info));
        
        // Espera 10 segundos
        sleep(10);
        
        // Desbloquea el archivo
        lockf(fd, F_ULOCK, 0);
    } else {
        // Error al bloquear
        perror("lockf");
    }
    
    close(fd);
    
    return 0;
}
